<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Motor Digital Twin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background: #0b1120;
            color: #e5e7eb;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 0;
            padding: 20px;
        }
        h1 {
            margin-bottom: 10px;
        }
        .subtitle {
            color: #9ca3af;
            margin-bottom: 24px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .card {
            background: #020617;
            border-radius: 16px;
            padding: 16px 18px;
            border: 1px solid #1f2937;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .label {
            font-size: 0.8rem;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: .08em;
            margin-bottom: 6px;
        }
        .value {
            font-size: 1.6rem;
            font-weight: 600;
        }
        .pill-ok {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 999px;
            background: #16a34a22;
            color: #bbf7d0;
            font-size: 0.75rem;
            margin-top: 4px;
        }
        .pill-warn {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 999px;
            background: #ea580c22;
            color: #fed7aa;
            font-size: 0.75rem;
            margin-top: 4px;
        }
        .charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
        }
        .chart-card {
            background: #020617;
            border-radius: 16px;
            padding: 16px;
            border: 1px solid #1f2937;
        }
        canvas {
            width: 100% !important;
            height: 220px !important;
        }
        .footer {
            margin-top: 16px;
            font-size: 0.8rem;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <h1>Motor Digital Twin</h1>
    <div class="subtitle">
        Edge-simulated motor with real-time health, anomaly score & live charts.
    </div>

    <!-- Top cards: current values -->
    <div class="grid">
        <div class="card">
            <div class="label">Temperature</div>
            <div class="value" id="tempValue">-- °C</div>
        </div>
        <div class="card">
            <div class="label">Vibration</div>
            <div class="value" id="vibValue">-- mm/s</div>
        </div>
        <div class="card">
            <div class="label">Current</div>
            <div class="value" id="currValue">-- A</div>
        </div>
        <div class="card">
            <div class="label">Speed</div>
            <div class="value" id="speedValue">-- RPM</div>
        </div>
        <div class="card">
            <div class="label">Health Score</div>
            <div class="value" id="healthValue">--</div>
        </div>
        <div class="card">
            <div class="label">Fault Class</div>
            <div class="value" id="faultLabel">--</div>
            <div id="faultStatus" class="pill-ok" style="display:none;"></div>
        </div>
    </div>

    <!-- Live charts -->
    <div class="charts">
        <div class="chart-card">
            <div class="label">Temperature Trend</div>
            <canvas id="tempChart"></canvas>
        </div>
        <div class="chart-card">
            <div class="label">Vibration Trend</div>
            <canvas id="vibChart"></canvas>
        </div>
        <div class="chart-card">
            <div class="label">Current Trend</div>
            <canvas id="currChart"></canvas>
        </div>
        <div class="chart-card">
            <div class="label">Speed Trend</div>
            <canvas id="speedChart"></canvas>
        </div>
    </div>

<div class="card glass-card mt-3 p-3">
  <h5 class="card-title">AI Recommendation</h5>
  <p id="ai-advice" class="text-info">--</p>
</div>


<script>
    let tempChart, vibChart, currChart, speedChart;

    function createLineChart(ctx, label) {
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: label,
                    data: [],
                    fill: false,
                    tension: 0.25
                }]
            },
            options: {
                responsive: true,
                animation: false,
                scales: {
                    x: {
                        ticks: { maxTicksLimit: 6 }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });
    }

    async function fetchData() {
        try {
            const res = await fetch("/api");
            const data = await res.json();

            const latest = data.latest;
            const history = data.history || [];

            // === TOP CARDS ===
            document.getElementById("tempValue").innerText =
                latest.temp.toFixed(2) + " °C";

            document.getElementById("vibValue").innerText =
                latest.vibration.toFixed(2) + " mm/s";

            document.getElementById("currValue").innerText =
                latest.current.toFixed(2) + " A";

            document.getElementById("speedValue").innerText =
                latest.speed.toFixed(0) + " RPM";

            document.getElementById("healthValue").innerText =
                latest.health.toFixed(1);

            // === FAULT CLASS ===
            const faultLabel = latest.fault_class || "Unknown";
            document.getElementById("faultLabel").innerText = faultLabel;

            const statusEl = document.getElementById("faultStatus");
            statusEl.style.display = "inline-block";
            if (faultLabel === "Normal") {
                statusEl.className = "pill-ok";
                statusEl.innerText = "NORMAL";
            } else {
                statusEl.className = "pill-warn";
                statusEl.innerText = "FAULTY";
            }

            // === AI RECOMMENDATION ===
            document.getElementById("ai-advice").innerText = latest.advice;

            // === CHARTS DATA ===
            const labels = history.map(p =>
                new Date(p.timestamp * 1000).toLocaleTimeString()
            );
            const temps = history.map(p => p.temp);
            const vibs = history.map(p => p.vibration);
            const currents = history.map(p => p.current);
            const speeds = history.map(p => p.speed);

            // === INIT CHARTS ONCE ===
            if (!tempChart) {
                tempChart = createLineChart(
                    document.getElementById("tempChart"),
                    "Temperature"
                );
                vibChart = createLineChart(
                    document.getElementById("vibChart"),
                    "Vibration"
                );
                currChart = createLineChart(
                    document.getElementById("currChart"),
                    "Current"
                );
                speedChart = createLineChart(
                    document.getElementById("speedChart"),
                    "Speed"
                );
            }

            // === UPDATE CHARTS ===
            tempChart.data.labels = labels;
            tempChart.data.datasets[0].data = temps;
            tempChart.update();

            vibChart.data.labels = labels;
            vibChart.data.datasets[0].data = vibs;
            vibChart.update();

            currChart.data.labels = labels;
            currChart.data.datasets[0].data = currents;
            currChart.update();

            speedChart.data.labels = labels;
            speedChart.data.datasets[0].data = speeds;
            speedChart.update();

        } catch (err) {
            console.error("Error fetching /api:", err);
        }
    }

    // Fetch immediately and then every 1 second
    fetchData();
    setInterval(fetchData, 1000);
</script>

</body>
</html>
